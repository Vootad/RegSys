{% extends 'base.html' %}

{% block content %}
<nav class="bg-white shadow-sm px-6 py-4 flex justify-between items-center mb-8">
    <h1 class="text-xl font-bold text-blue-800">داشبورد مدیریت دروس</h1>
    <button onclick="logout()" class="text-red-600 hover:text-red-800 font-medium text-sm border border-red-200 px-3 py-1 rounded">خروج</button>
</nav>

<div class="container mx-auto px-4">
    
<div class="bg-white p-6 rounded-lg shadow-md mb-8">
        <h3 class="text-lg font-bold mb-4 text-gray-700 border-b pb-2">افزودن / ویرایش درس</h3>
        <input type="hidden" id="lessonId"> 
        
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 items-start">
            
            <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="text-sm text-gray-600 mb-1 block">عنوان درس</label>
                    <input type="text" id="title" placeholder="مثال: مهندسی نرم افزار" class="input-field h-10">
                </div>
                <div>
                    <label class="text-sm text-gray-600 mb-1 block">کد درس</label>
                    <input type="text" id="code" placeholder="کد یکتا" class="input-field h-10">
                </div>
                <div>
                    <label class="text-sm text-gray-600 mb-1 block">ظرفیت</label>
                    <input type="number" id="capacity" placeholder="تعداد نفرات" class="input-field h-10">
                </div>
            </div>

            <div class="lg:col-span-1">
                <label class="text-sm text-gray-600 mb-1 block">زمان‌های برگزاری</label>
                <select id="timeSlots" multiple class="input-field h-40 text-sm">
                    </select>
                <p class="text-xs text-gray-500 mt-1 leading-relaxed">
                    <span class="text-blue-600 font-bold">*</span> 
                    کلید 
                    <span class="bg-gray-200 px-1 rounded border border-gray-300 font-mono">Ctrl</span> 
                    را برای انتخاب چندگانه نگه دارید.
                </p>
            </div>
        </div>
        
        <div class="mt-6 flex gap-2 border-t pt-4">
            <button onclick="saveLesson()" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 transition flex items-center gap-2 shadow-sm h-10">
                <span>ذخیره تغییرات</span>
            </button>
            <button onclick="clearForm()" class="bg-gray-100 text-gray-600 border border-gray-300 px-6 py-2 rounded hover:bg-gray-200 transition h-10">
                انصراف
            </button>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
        <table class="w-full text-right">
            <thead class="bg-gray-50 text-gray-700 border-b border-gray-200">
                <tr>
                    <th class="p-4 font-semibold">عنوان درس</th>
                    <th class="p-4 font-semibold">کد درس</th>
                    <th class="p-4 font-semibold">ظرفیت</th>
                    <th class="p-4 font-semibold w-1/3">زمان‌بندی کامل</th>
                    <th class="p-4 text-center font-semibold">عملیات</th>
                </tr>
            </thead>
            <tbody id="lessonsTableBody" class="divide-y divide-gray-100">
                </tbody>
        </table>
    </div>
</div>

<style>
    .input-field {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        outline: none;
        transition: all 0.2s;
        background-color: #fff;
    }
    .input-field:focus {
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    /* استایل اسکرول بار برای لیست سلکت */
    select[multiple] {
        padding-right: 0.25rem;
    }
    select[multiple]::-webkit-scrollbar {
        width: 6px;
    }
    select[multiple]::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 4px;
    }
</style>

<script>
    const API_URL = '/api/lessons/';
    const TIME_URL = '/api/timeslots/';
    
    // بررسی لاگین بودن
    const token = localStorage.getItem('access_token');
    if (!token) window.location.href = '/';

    const headers = {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
    };

    // --- توابع اصلی ---

    // ۱. دریافت و نمایش درس‌ها
    async function fetchLessons() {
        try {
            const res = await fetch(API_URL, { headers });
            if (res.status === 401) return logout();
            const lessons = await res.json();
            
            const tbody = document.getElementById('lessonsTableBody');
            tbody.innerHTML = '';
            
            if (lessons.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-500">هنوز درسی ثبت نشده است.</td></tr>';
                return;
            }

            lessons.forEach(lesson => {
                // ساختن HTML برای نمایش زمان‌ها به صورت کامل
                // هر زمان در یک باکس کوچک جداگانه قرار می‌گیرد
                let timesText = lesson.time_slots_details.map(t => 
                    `<div class="bg-blue-50 text-blue-900 text-sm px-3 py-1.5 rounded mb-1 border-r-4 border-blue-400 flex justify-between items-center shadow-sm">
                        <span class="font-bold ml-2">${t.day_display}</span>
                        <span class="text-gray-600 text-xs">از ${t.start_time.slice(0,5)} تا ${t.end_time.slice(0,5)}</span>
                    </div>`
                ).join('');
                
                if (!timesText) timesText = '<span class="text-gray-400 text-sm italic">بدون زمان‌بندی</span>';

                const row = `
                    <tr class="hover:bg-gray-50 transition group">
                        <td class="p-4 font-bold text-gray-800 align-top">${lesson.title}</td>
                        <td class="p-4 text-gray-600 align-top font-mono text-sm">${lesson.unique_code}</td>
                        <td class="p-4 text-gray-600 align-top">
                            <span class="bg-gray-100 px-2 py-1 rounded text-sm">${lesson.capacity} نفر</span>
                        </td>
                        <td class="p-4 align-top">
                            <div class="flex flex-col gap-1">
                                ${timesText}
                            </div>
                        </td>
                        <td class="p-4 text-center align-top">
                            <div class="flex justify-center gap-3">
                                <button onclick='editLesson(${JSON.stringify(lesson)})' class="text-blue-600 hover:text-blue-800 text-sm font-medium border border-blue-200 hover:bg-blue-50 px-3 py-1 rounded transition">ویرایش</button>
                                <button onclick="deleteLesson(${lesson.id})" class="text-red-600 hover:text-red-800 text-sm font-medium border border-red-200 hover:bg-red-50 px-3 py-1 rounded transition">حذف</button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        } catch (err) { console.error(err); }
    }

    // ۲. دریافت زمان‌بندی‌ها
    async function fetchTimeSlots() {
        const res = await fetch(TIME_URL, { headers });
        const slots = await res.json();
        const select = document.getElementById('timeSlots');
        select.innerHTML = '';
        slots.forEach(slot => {
            const option = document.createElement('option');
            option.value = slot.id;
            // نمایش در لیست کشویی
            option.text = `${slot.day_display} | ${slot.start_time.slice(0,5)} - ${slot.end_time.slice(0,5)}`;
            option.classList.add('py-1', 'px-2'); // کمی فاصله برای زیبایی گزینه‌ها
            select.appendChild(option);
        });
    }

    // ۳. ذخیره
    async function saveLesson() {
        const id = document.getElementById('lessonId').value;
        const title = document.getElementById('title').value;
        const unique_code = document.getElementById('code').value;
        const capacity = document.getElementById('capacity').value;
        const selectedOptions = Array.from(document.getElementById('timeSlots').selectedOptions).map(opt => opt.value);

        if (!title || !unique_code || !capacity) {
            alert('لطفا تمام فیلدها را پر کنید.');
            return;
        }

        const data = { title, unique_code, capacity, time_slots: selectedOptions };
        
        let method = 'POST';
        let url = API_URL;

        if (id) {
            method = 'PUT';
            url += `${id}/`;
        }

        const res = await fetch(url, {
            method: method,
            headers: headers,
            body: JSON.stringify(data)
        });

        if (res.ok) {
            fetchLessons();
            clearForm();
        } else {
            alert('خطا در ذخیره. ممکن است کد درس تکراری باشد.');
        }
    }

    // ۴. حذف
    async function deleteLesson(id) {
        if(!confirm('آیا از حذف این درس اطمینان دارید؟')) return;
        await fetch(API_URL + `${id}/`, { method: 'DELETE', headers });
        fetchLessons();
    }

    // ۵. ویرایش
    function editLesson(lesson) {
        document.getElementById('lessonId').value = lesson.id;
        document.getElementById('title').value = lesson.title;
        document.getElementById('code').value = lesson.unique_code;
        document.getElementById('capacity').value = lesson.capacity;
        
        const select = document.getElementById('timeSlots');
        const lessonTimeIds = lesson.time_slots_details.map(t => t.id);
        
        Array.from(select.options).forEach(opt => {
            opt.selected = lessonTimeIds.includes(parseInt(opt.value));
        });
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
        // هایلایت کردن فرم برای توجه کاربر
        document.querySelector('.bg-white.p-6').classList.add('ring-2', 'ring-blue-400');
        setTimeout(() => {
            document.querySelector('.bg-white.p-6').classList.remove('ring-2', 'ring-blue-400');
        }, 1000);
    }

    function clearForm() {
        document.getElementById('lessonId').value = '';
        document.getElementById('title').value = '';
        document.getElementById('code').value = '';
        document.getElementById('capacity').value = '';
        document.getElementById('timeSlots').selectedIndex = -1;
    }

    function logout() {
        localStorage.removeItem('access_token');
        localStorage.removeItem('refresh_token');
        window.location.href = '/';
    }

    fetchTimeSlots();
    fetchLessons();

</script>
{% endblock %}